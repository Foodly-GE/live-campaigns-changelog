{% extends "base.html" %}

{% block title %}Calendar - Campaign Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Calendar</h1>
    <p class="text-secondary">Campaign status overview — live, finished &amp; scheduled</p>
</div>

<!-- Global Filters -->
<div class="filters-section">
    <div class="filter-group">
        <label for="account-manager-filter">Account Manager</label>
        <select id="account-manager-filter">
            <option value="">All managers</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="spend-objective-filter">Spend Objective</label>
        <select id="spend-objective-filter">
            <option value="">All objectives</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="bonus-type-filter">Bonus Type</label>
        <select id="bonus-type-filter">
            <option value="">All types</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Provider Name</label>
        <div class="multiselect-wrapper" id="provider-multiselect">
            <button type="button" class="multiselect-toggle">All providers</button>
            <div class="multiselect-dropdown"></div>
        </div>
    </div>
    <div class="filter-group">
        <label for="city-filter">City</label>
        <select id="city-filter">
            <option value="">All cities</option>
        </select>
    </div>
</div>

<!-- Progression Section -->
<section class="progression-section">
    <h2 class="section-title">Daily Progression</h2>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card green">
            <div class="stat-value" id="stat-live">0</div>
            <div class="stat-label">Live</div>
            <div class="stat-change" id="wow-live"><span>--</span></div>
        </div>
        <div class="stat-card pink">
            <div class="stat-value" id="stat-finished">0</div>
            <div class="stat-label">Finished</div>
            <div class="stat-change" id="wow-finished"><span>--</span></div>
        </div>
        <div class="stat-card cyan">
            <div class="stat-value" id="stat-scheduled">0</div>
            <div class="stat-label">Scheduled</div>
            <div class="stat-change" id="wow-scheduled"><span>--</span></div>
        </div>
    </div>

    <!-- Chart -->
    <div class="chart-section">
        <div class="chart-container">
            <canvas id="calendar-chart"></canvas>
        </div>
    </div>
</section>

<!-- Details Section -->
<section class="details-section">
    <h2 class="section-title">Details</h2>

    <!-- Live -->
    <div class="detail-group">
        <div class="detail-group-header" onclick="toggleGroup(this)">
            <span class="group-indicator green"></span>
            <span class="group-title">Live</span>
            <span class="group-count" id="count-live">0</span>
        </div>
        <div class="detail-group-content">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Provider ID</th>
                            <th>Provider Name</th>
                            <th>Account Manager</th>
                            <th>City</th>
                            <th>Spend Objective</th>
                            <th>Bonus Type</th>
                            <th>Bonus %</th>
                            <th>Campaign Start</th>
                            <th>Campaign End</th>
                            <th>Bonus Max Value</th>
                            <th>Min Basket Size</th>
                            <th>Campaign ID</th>
                            <th>Diff (changes)</th>
                            <th>Hash ID</th>
                            <th>Banner Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-live">
                        <tr>
                            <td colspan="15" class="empty-state">No data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Finished -->
    <div class="detail-group">
        <div class="detail-group-header" onclick="toggleGroup(this)">
            <span class="group-indicator pink"></span>
            <span class="group-title">Finished</span>
            <span class="group-count" id="count-finished">0</span>
        </div>
        <div class="detail-group-content">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Provider ID</th>
                            <th>Provider Name</th>
                            <th>Account Manager</th>
                            <th>City</th>
                            <th>Spend Objective</th>
                            <th>Bonus Type</th>
                            <th>Bonus %</th>
                            <th>Campaign Start</th>
                            <th>Campaign End</th>
                            <th>Bonus Max Value</th>
                            <th>Min Basket Size</th>
                            <th>Campaign ID</th>
                            <th>Diff (changes)</th>
                            <th>Hash ID</th>
                            <th>Banner Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-finished">
                        <tr>
                            <td colspan="15" class="empty-state">No data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scheduled -->
    <div class="detail-group">
        <div class="detail-group-header" onclick="toggleGroup(this)">
            <span class="group-indicator cyan"></span>
            <span class="group-title">Scheduled</span>
            <span class="group-count" id="count-scheduled">0</span>
        </div>
        <div class="detail-group-content">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Provider ID</th>
                            <th>Provider Name</th>
                            <th>Account Manager</th>
                            <th>City</th>
                            <th>Spend Objective</th>
                            <th>Bonus Type</th>
                            <th>Bonus %</th>
                            <th>Campaign Start</th>
                            <th>Campaign End</th>
                            <th>Bonus Max Value</th>
                            <th>Min Basket Size</th>
                            <th>Campaign ID</th>
                            <th>Diff (changes)</th>
                            <th>Hash ID</th>
                            <th>Banner Action</th>
                        </tr>
                    </thead>
                    <tbody id="table-scheduled">
                        <tr>
                            <td colspan="15" class="empty-state">No data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const BONUS_TYPE_ORDER = [
        'percentage_of_food_price',
        'percentage_of_full_delivery_price'
    ];

    let allData = null;
    let calendarChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadCalendarData();
        initCellExpand();
        initMultiSelect('provider-multiselect', applyFiltersAndSort);

        document.getElementById('city-filter').addEventListener('change', loadCalendarData);
        document.getElementById('account-manager-filter').addEventListener('change', applyFiltersAndSort);
        document.getElementById('bonus-type-filter').addEventListener('change', applyFiltersAndSort);
        document.getElementById('spend-objective-filter').addEventListener('change', applyFiltersAndSort);
    });

    async function loadCalendarData() {
        const cityFilter = document.getElementById('city-filter').value;

        let url = '/api/calendar';
        if (cityFilter) url += `?city=${cityFilter}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            allData = data;

            updateStats(data.summary, data.prev_summary);
            updateChart(data.time_series);
            populateCityFilter(data.filters);
            populateAdvancedFilters(data.grouped);
            applyFiltersAndSort();
        } catch (error) {
            console.error('Error loading calendar:', error);
        }
    }

    function populateCityFilter(filters) {
        const citySelect = document.getElementById('city-filter');
        const currentCity = citySelect.value;
        if (citySelect.options.length <= 1) {
            (filters.cities || []).forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
        citySelect.value = currentCity;
    }

    function populateAdvancedFilters(grouped) {
        if (!grouped) return;

        const allEntries = [
            ...(grouped.live || []),
            ...(grouped.finished || []),
            ...(grouped.scheduled || [])
        ];

        const managers = [...new Set(allEntries.map(e => e.account_manager).filter(Boolean))].sort();
        const managerSelect = document.getElementById('account-manager-filter');
        const currentManager = managerSelect.value;
        managerSelect.innerHTML = '<option value="">All managers</option>';
        managers.forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            option.textContent = m;
            managerSelect.appendChild(option);
        });
        managerSelect.value = currentManager;

        const bonusTypes = [...new Set(allEntries.map(e => e.bonus_type).filter(Boolean))].sort();
        const bonusTypeSelect = document.getElementById('bonus-type-filter');
        const currentBT = bonusTypeSelect.value;
        bonusTypeSelect.innerHTML = '<option value="">All types</option>';
        bonusTypes.forEach(t => {
            const option = document.createElement('option');
            option.value = t;
            option.textContent = t;
            bonusTypeSelect.appendChild(option);
        });
        bonusTypeSelect.value = currentBT;

        const objectives = [...new Set(allEntries.map(e => e.spend_objective).filter(Boolean))].sort();
        const objectiveSelect = document.getElementById('spend-objective-filter');
        const currentObj = objectiveSelect.value;
        objectiveSelect.innerHTML = '<option value="">All objectives</option>';
        objectives.forEach(o => {
            const option = document.createElement('option');
            option.value = o;
            option.textContent = o;
            objectiveSelect.appendChild(option);
        });
        objectiveSelect.value = currentObj;

        // Provider multi-select
        const providers = [...new Set(allEntries.map(e => e.provider_name).filter(Boolean))].sort();
        populateMultiSelect('provider-multiselect', providers);
    }

    function applyFiltersAndSort() {
        if (!allData) return;

        const selectedProviders = getMultiSelectValues('provider-multiselect');
        const managerFilter = document.getElementById('account-manager-filter').value;
        const bonusTypeFilter = document.getElementById('bonus-type-filter').value;
        const objectiveFilter = document.getElementById('spend-objective-filter').value;

        const filterFn = (entry) => {
            if (selectedProviders.length > 0 && !selectedProviders.includes(entry.provider_name)) return false;
            if (managerFilter && entry.account_manager !== managerFilter) return false;
            if (bonusTypeFilter && entry.bonus_type !== bonusTypeFilter) return false;
            if (objectiveFilter && entry.spend_objective !== objectiveFilter) return false;
            return true;
        };

        const filtered = {
            live: sortEntries((allData.grouped.live || []).filter(filterFn)),
            finished: sortEntries((allData.grouped.finished || []).filter(filterFn)),
            scheduled: sortEntries((allData.grouped.scheduled || []).filter(filterFn))
        };

        updateTables(filtered);
    }

    function sortEntries(entries) {
        if (!entries || entries.length === 0) return entries;

        return [...entries].sort((a, b) => {
            const typeA = a.bonus_type || '';
            const typeB = b.bonus_type || '';
            const idxA = BONUS_TYPE_ORDER.indexOf(typeA);
            const idxB = BONUS_TYPE_ORDER.indexOf(typeB);

            if (idxA !== -1 && idxB !== -1) {
                if (idxA !== idxB) return idxA - idxB;
            } else if (idxA !== -1) return -1;
            else if (idxB !== -1) return 1;
            else if (typeA !== typeB) return typeB.localeCompare(typeA);

            const pctA = parseFloat(a.bonus_percentage) || 0;
            const pctB = parseFloat(b.bonus_percentage) || 0;
            if (pctA !== pctB) return pctB - pctA;

            const objA = a.spend_objective || '';
            const objB = b.spend_objective || '';
            if (objA !== objB) return objA.localeCompare(objB);

            const endA = new Date(a.campaign_end || 0);
            const endB = new Date(b.campaign_end || 0);
            return endA - endB;
        });
    }

    function updateStats(summary, prevSummary) {
        if (!summary) return;

        updateStatCard('live', summary.live || 0, (prevSummary && prevSummary.live) || 0);
        updateStatCard('finished', summary.finished || 0, (prevSummary && prevSummary.finished) || 0);
        updateStatCard('scheduled', summary.scheduled || 0, (prevSummary && prevSummary.scheduled) || 0);
    }

    function updateStatCard(idSuffix, current, previous) {
        document.getElementById(`stat-${idSuffix}`).textContent = current;

        const wowEl = document.getElementById(`wow-${idSuffix}`);
        const diff = current - previous;
        const diffText = diff > 0 ? `+${diff}` : `${diff}`;
        const arrow = diff > 0 ? '↑' : (diff < 0 ? '↓' : '');
        const colorClass = diff > 0 ? 'up' : (diff < 0 ? 'down' : '');

        if (diff === 0) {
            wowEl.innerHTML = '<span class="text-muted">— vs prev day</span>';
        } else {
            wowEl.innerHTML = `<span class="${colorClass}">${arrow} ${diffText} vs prev day</span>`;
        }
    }

    function updateChart(timeSeries) {
        if (!timeSeries || Object.keys(timeSeries).length === 0) {
            console.warn('No time series data for calendar chart');
            return;
        }

        const ctx = document.getElementById('calendar-chart').getContext('2d');

        const labels = Object.keys(timeSeries).sort();
        const liveData = labels.map(d => timeSeries[d].live || 0);
        const finishedData = labels.map(d => timeSeries[d].finished || 0);
        const scheduledData = labels.map(d => timeSeries[d].scheduled || 0);

        if (calendarChart) {
            calendarChart.destroy();
        }

        const formattedLabels = labels.map(d => {
            const dt = new Date(d + 'T00:00:00');
            return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        calendarChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: [
                    {
                        label: 'Live',
                        data: liveData,
                        borderColor: '#34d399',
                        backgroundColor: 'transparent',
                        tension: 0.35,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#34d399',
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Finished',
                        data: finishedData,
                        borderColor: '#fb7185',
                        backgroundColor: 'transparent',
                        tension: 0.35,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fb7185',
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Scheduled',
                        data: scheduledData,
                        borderColor: '#22d3ee',
                        backgroundColor: 'transparent',
                        tension: 0.35,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#22d3ee',
                        pointHoverRadius: 6
                    }
                ]
            },
            options: window.darkChartOptions
        });
    }

    function updateTables(grouped) {
        const statusGroups = ['live', 'finished', 'scheduled'];

        statusGroups.forEach(status => {
            const entries = grouped[status] || [];
            const tbody = document.getElementById(`table-${status}`);

            document.getElementById(`count-${status}`).textContent = entries.length;

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="empty-state">No data</td></tr>';
                return;
            }

            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td>${entry.provider_id || '-'}</td>
                    <td>${entry.provider_name || '-'}</td>
                    <td>${entry.account_manager || '-'}</td>
                    <td>${entry.city || '-'}</td>
                    <td><span class="objective-badge">${entry.spend_objective || '-'}</span></td>
                    <td><span class="bonus-type-badge">${entry.bonus_type || '-'}</span></td>
                    <td>${entry.bonus_percentage || '-'}%</td>
                    <td>${formatDate(entry.campaign_start)}</td>
                    <td>${formatDate(entry.campaign_end)}</td>
                    <td>${entry.bonus_max_value || '-'}</td>
                    <td>${entry.min_basket_size || '-'}</td>
                    <td>${entry.campaign_id || '-'}</td>
                    <td><span class="text-muted">—</span></td>
                    <td><code>${entry.campaign_hash || '-'}</code></td>
                    <td><span class="text-muted">—</span></td>
                </tr>
            `).join('');
        });
    }
</script>
{% endblock %}